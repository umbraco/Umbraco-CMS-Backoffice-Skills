---
name: umbraco-msw-testing
description: MSW (Mock Service Worker) patterns for testing Umbraco backoffice extensions with mocked APIs
version: 1.0.0
location: managed
allowed-tools: Read, Write, Edit, WebFetch
---

# Umbraco MSW Testing

## What is it?

MSW (Mock Service Worker) enables testing Umbraco backoffice extensions by intercepting API calls and returning mock responses. This is ideal for testing error states, loading states, and edge cases without a running Umbraco instance.

## When to Use

- Testing API error handling (404, 500, validation errors)
- Testing loading spinners and skeleton states
- Testing network retry behavior
- Testing edge cases without backend setup
- Adding API mocking to unit tests

## Related Skills

- **umbraco-testing** - Master skill for testing overview
- **umbraco-unit-testing** - Unit testing patterns (combine with MSW)

## Documentation

- **MSW Docs**: https://mswjs.io/docs/
- **Reference handlers**: `Umbraco-CMS/src/Umbraco.Web.UI.Client/src/mocks/handlers/`

---

## Setup

### Dependencies

Add to `package.json`:

```json
{
  "devDependencies": {
    "@open-wc/testing": "^4.0.0",
    "@web/dev-server-esbuild": "^1.0.0",
    "@web/dev-server-import-maps": "^0.2.0",
    "@web/test-runner": "^0.18.0",
    "@web/test-runner-playwright": "^0.11.0",
    "msw": "^1.3.5"
  },
  "scripts": {
    "postinstall": "npx msw init . --save",
    "test": "web-test-runner",
    "test:watch": "web-test-runner --watch"
  }
}
```

Then run:
```bash
npm install
npx playwright install chromium
```

The `postinstall` script copies `mockServiceWorker.js` to your project root. **Without this file, MSW will fail silently.**

### Configuration

Create `web-test-runner.config.mjs`:

```javascript
import { esbuildPlugin } from '@web/dev-server-esbuild';
import { playwrightLauncher } from '@web/test-runner-playwright';
import { importMapsPlugin } from '@web/dev-server-import-maps';

export default {
  rootDir: '.',
  files: ['./src/**/*.test.ts', '!**/node_modules/**'],
  nodeResolve: {
    exportConditions: ['development'],
    preferBuiltins: false,
    browser: false,
  },
  browsers: [playwrightLauncher({ product: 'chromium' })],
  plugins: [
    importMapsPlugin({
      inject: {
        importMap: {
          imports: {
            '@umbraco-cms/backoffice/external/lit': '/node_modules/lit/index.js',
            '@umbraco-cms/backoffice/lit-element':
              '/node_modules/@umbraco-cms/backoffice/dist-cms/packages/core/lit-element/index.js',
            '@umbraco-cms/backoffice/element-api':
              '/node_modules/@umbraco-cms/backoffice/dist-cms/libs/element-api/index.js',
            '@umbraco-cms/backoffice/observable-api':
              '/node_modules/@umbraco-cms/backoffice/dist-cms/libs/observable-api/index.js',
            '@umbraco-cms/backoffice/context-api':
              '/node_modules/@umbraco-cms/backoffice/dist-cms/libs/context-api/index.js',
            '@umbraco-cms/backoffice/controller-api':
              '/node_modules/@umbraco-cms/backoffice/dist-cms/libs/controller-api/index.js',
            '@umbraco-cms/backoffice/class-api':
              '/node_modules/@umbraco-cms/backoffice/dist-cms/packages/core/class-api/index.js',
          },
        },
      },
    }),
    esbuildPlugin({
      ts: true,
      tsconfig: './tsconfig.json',
      target: 'auto',
      json: true,
    }),
  ],
  testRunnerHtml: (testFramework) =>
    `<html lang="en-us">
      <head>
        <meta charset="UTF-8" />
        <!-- Load MSW as IIFE to get window.MockServiceWorker -->
        <script src="/node_modules/msw/lib/iife/index.js"></script>
      </head>
      <body>
        <script type="module" src="${testFramework}"></script>
      </body>
    </html>`,
};
```

### Directory Structure

```
my-extension/
├── src/
│   ├── my-element.ts
│   ├── my-element.test.ts
│   └── mocks/
│       ├── handlers.ts         # MSW handlers
│       ├── setup.ts            # Worker setup
│       └── data/
│           └── items.db.ts     # Mock database
├── mockServiceWorker.js        # Generated by postinstall
├── web-test-runner.config.mjs
├── package.json
└── tsconfig.json
```

---

## Patterns

### MSW v1 Syntax (Important)

Umbraco uses **MSW v1.3.5**. Key differences from v2:

| MSW v1 (Umbraco) | MSW v2 |
|-----------------|--------|
| `rest.get()` | `http.get()` |
| `res(ctx.json())` | `HttpResponse.json()` |
| `window.MockServiceWorker` | `import { http }` |

### Global MSW Access

```typescript
const { rest } = window.MockServiceWorker;
```

### umbracoPath Helper

```typescript
import { umbracoPath } from '@umbraco-cms/backoffice/utils';

// Creates: /umbraco/management/api/v1/document/:id
umbracoPath('/document/:id')
```

### Basic Handlers

**GET Handler:**
```typescript
const { rest } = window.MockServiceWorker;
import { umbracoPath } from '@umbraco-cms/backoffice/utils';

export const handlers = [
  rest.get(umbracoPath('/document/:id'), (req, res, ctx) => {
    const id = req.params.id as string;
    return res(
      ctx.status(200),
      ctx.json({
        id,
        name: 'Test Document',
        documentType: { alias: 'testType' },
      })
    );
  }),
];
```

**POST Handler:**
```typescript
rest.post(umbracoPath('/document'), async (req, res, ctx) => {
  const body = await req.json();

  if (!body.name) {
    return res(
      ctx.status(400),
      ctx.json({
        type: 'validation',
        status: 400,
        errors: { name: ['Name is required'] },
      })
    );
  }

  const newId = crypto.randomUUID();
  return res(
    ctx.status(201),
    ctx.set({ 'Umb-Generated-Resource': newId })
  );
}),
```

**PUT Handler:**
```typescript
rest.put(umbracoPath('/document/:id'), async (req, res, ctx) => {
  const id = req.params.id as string;
  const body = await req.json();
  mockDb.update(id, body);
  return res(ctx.status(200));
}),
```

**DELETE Handler:**
```typescript
rest.delete(umbracoPath('/document/:id'), (req, res, ctx) => {
  const id = req.params.id as string;
  mockDb.delete(id);
  return res(ctx.status(200));
}),
```

### Simulating States

**Error Responses:**
```typescript
// 404 Not Found
rest.get(umbracoPath('/document/:id'), (req, res, ctx) => {
  const doc = mockDb.read(req.params.id as string);
  if (!doc) return res(ctx.status(404));
  return res(ctx.status(200), ctx.json(doc));
}),

// 500 Server Error
rest.get(umbracoPath('/document/:id'), (req, res, ctx) => {
  return res(
    ctx.status(500),
    ctx.json({ type: 'error', detail: 'Internal server error' })
  );
}),
```

**Validation Errors:**
```typescript
rest.post(umbracoPath('/document'), async (req, res, ctx) => {
  const body = await req.json();
  if (!body.name) {
    return res(
      ctx.status(400),
      ctx.json({
        type: 'validation',
        errors: {
          name: ['Name is required'],
          title: ['Title must be at least 3 characters'],
        },
      })
    );
  }
  return res(ctx.status(201));
}),
```

**Delayed Responses (Loading States):**
```typescript
rest.get(umbracoPath('/slow-endpoint'), (req, res, ctx) => {
  return res(
    ctx.delay(2000),
    ctx.status(200),
    ctx.json({ data: 'loaded' })
  );
}),
```

### Mock Database Pattern

```typescript
// src/mocks/data/items.db.ts
interface Item {
  id: string;
  name: string;
  value: number;
}

class ItemsMockDb {
  private data: Item[] = [
    { id: '1', name: 'Item 1', value: 100 },
    { id: '2', name: 'Item 2', value: 200 },
  ];

  read(id: string) {
    return this.data.find((item) => item.id === id);
  }

  readAll() {
    return [...this.data];
  }

  create(item: Omit<Item, 'id'>) {
    const newItem = { ...item, id: crypto.randomUUID() };
    this.data.push(newItem);
    return newItem.id;
  }

  update(id: string, updates: Partial<Item>) {
    const index = this.data.findIndex((i) => i.id === id);
    if (index !== -1) {
      this.data[index] = { ...this.data[index], ...updates };
    }
  }

  delete(id: string) {
    this.data = this.data.filter((i) => i.id !== id);
  }
}

export const itemsDb = new ItemsMockDb();
```

### Worker Setup

```typescript
// src/mocks/setup.ts
const { setupWorker } = window.MockServiceWorker;
import { handlers } from './handlers.js';

const worker = setupWorker(...handlers);

export const startMockServiceWorker = () =>
  worker.start({
    onUnhandledRequest: 'warn',
    quiet: true,
  });
```

### Integration with Tests

**In test file:**
```typescript
import { expect, fixture } from '@open-wc/testing';
import { startMockServiceWorker } from './mocks/setup.js';
import './my-element.js';

// Start MSW before tests
before(async () => {
  await startMockServiceWorker();
});

describe('MyElement with API', () => {
  it('displays data from API', async () => {
    const element = await fixture(html`<my-element></my-element>`);
    await element.updateComplete;

    // Element should show mocked data
    expect(element.shadowRoot?.textContent).to.include('Item 1');
  });
});
```

---

## Examples

### Complete Handler File

```typescript
// src/mocks/handlers.ts
const { rest } = window.MockServiceWorker;
import { umbracoPath } from '@umbraco-cms/backoffice/utils';
import { itemsDb } from './data/items.db.js';

export const handlers = [
  // List items
  rest.get(umbracoPath('/my-extension/items'), (req, res, ctx) => {
    const items = itemsDb.readAll();
    return res(
      ctx.status(200),
      ctx.json({ total: items.length, items })
    );
  }),

  // Get single item
  rest.get(umbracoPath('/my-extension/items/:id'), (req, res, ctx) => {
    const item = itemsDb.read(req.params.id as string);
    if (!item) return res(ctx.status(404));
    return res(ctx.status(200), ctx.json(item));
  }),

  // Create item
  rest.post(umbracoPath('/my-extension/items'), async (req, res, ctx) => {
    const body = await req.json();
    if (!body.name) {
      return res(
        ctx.status(400),
        ctx.json({ type: 'validation', errors: { name: ['Required'] } })
      );
    }
    const id = itemsDb.create(body);
    return res(
      ctx.status(201),
      ctx.set({ 'Umb-Generated-Resource': id })
    );
  }),

  // Update item
  rest.put(umbracoPath('/my-extension/items/:id'), async (req, res, ctx) => {
    const id = req.params.id as string;
    if (!itemsDb.read(id)) return res(ctx.status(404));
    itemsDb.update(id, await req.json());
    return res(ctx.status(200));
  }),

  // Delete item
  rest.delete(umbracoPath('/my-extension/items/:id'), (req, res, ctx) => {
    const id = req.params.id as string;
    if (!itemsDb.read(id)) return res(ctx.status(404));
    itemsDb.delete(id);
    return res(ctx.status(200));
  }),
];
```

### Handler Organization

```
src/mocks/
├── handlers.ts             # Aggregates all handlers
├── setup.ts                # Worker setup
├── handlers/
│   ├── document.handlers.ts
│   ├── media.handlers.ts
│   └── my-extension.handlers.ts
└── data/
    ├── document.db.ts
    └── items.db.ts
```

```typescript
// handlers.ts
import { documentHandlers } from './handlers/document.handlers.js';
import { mediaHandlers } from './handlers/media.handlers.js';
import { myExtensionHandlers } from './handlers/my-extension.handlers.js';

export const handlers = [
  ...documentHandlers,
  ...mediaHandlers,
  ...myExtensionHandlers,
];
```

---

## Running Tests

```bash
# Run all tests
npm test

# Run in watch mode
npm run test:watch

# Run specific file
npx web-test-runner src/my-element.test.ts
```

---

## Troubleshooting

### MSW not intercepting requests

1. Check `mockServiceWorker.js` exists in project root
2. Verify MSW script is loaded in test HTML: `<script src="/node_modules/msw/lib/iife/index.js"></script>`
3. Ensure worker is started before tests run

### "rest is not defined"

Use global access: `const { rest } = window.MockServiceWorker;`

### Handler not matching

Check path matches exactly. Use `umbracoPath()` for Umbraco API paths.

### Requests still hitting real server

Ensure `onUnhandledRequest: 'warn'` is set to see unhandled requests in console.
