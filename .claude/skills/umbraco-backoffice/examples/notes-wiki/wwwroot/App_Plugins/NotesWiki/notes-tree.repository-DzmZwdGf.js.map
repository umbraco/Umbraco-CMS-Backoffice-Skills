{"version":3,"file":"notes-tree.repository-DzmZwdGf.js","sources":["../../../Client/src/tree/notes-tree.server.data-source.ts","../../../Client/src/tree/notes-tree.repository.ts"],"sourcesContent":["/**\r\n * @fileoverview Notes Tree Server Data Source\r\n *\r\n * The data source is responsible for fetching tree data from the C# backend API.\r\n * It uses the generated OpenAPI client (hey-api) for type-safe API calls.\r\n *\r\n * **Role in the Repository Pattern:**\r\n *\r\n * ```\r\n * Repository ─────> Data Source ─────> OpenAPI Client ─────> C# API\r\n * ```\r\n *\r\n * The data source handles the low-level details of:\r\n * - Making HTTP requests to the tree API endpoints\r\n * - Transforming API responses to Umbraco tree models\r\n * - Handling pagination parameters (skip/take)\r\n *\r\n * **Required Methods:**\r\n *\r\n * The base class `UmbTreeServerDataSourceBase` expects four functions:\r\n * 1. `getRootItems` - Fetch items at the root level\r\n * 2. `getChildrenOf` - Fetch children of a parent item\r\n * 3. `getAncestorsOf` - Fetch ancestors for breadcrumb/path\r\n * 4. `mapper` - Transform API response to tree item model\r\n *\r\n * **Authentication:**\r\n *\r\n * The OpenAPI client is configured with Umbraco's auth token in the entry point.\r\n * All requests automatically include the bearer token for authentication.\r\n *\r\n * Skills demonstrated: umbraco-repository-pattern, umbraco-tree, umbraco-openapi-client\r\n */\r\n\r\nimport type { UmbControllerHost } from \"@umbraco-cms/backoffice/controller-api\";\r\nimport type {\r\n  UmbTreeAncestorsOfRequestArgs,\r\n  UmbTreeChildrenOfRequestArgs,\r\n  UmbTreeRootItemsRequestArgs,\r\n} from \"@umbraco-cms/backoffice/tree\";\r\nimport { UmbTreeServerDataSourceBase } from \"@umbraco-cms/backoffice/tree\";\r\nimport {\r\n  NOTES_ROOT_ENTITY_TYPE,\r\n  NOTES_FOLDER_ENTITY_TYPE,\r\n  NOTES_NOTE_ENTITY_TYPE,\r\n} from \"../constants.js\";\r\nimport type { NotesTreeItemModel } from \"./types.js\";\r\nimport type { TreeItemModel } from \"../api/index.js\";\r\nimport { NoteswikiService } from \"../api/index.js\";\r\n\r\n/**\r\n * Data source for fetching Notes tree data from the server.\r\n *\r\n * Extends `UmbTreeServerDataSourceBase` which provides the standard interface\r\n * expected by tree repositories. The type parameters define:\r\n * - `TreeItemModel` - The shape of API responses (from OpenAPI types)\r\n * - `NotesTreeItemModel` - The shape of transformed tree items\r\n *\r\n * @example\r\n * // The data source is typically not used directly.\r\n * // Instead, it's passed to the repository constructor:\r\n * class NotesTreeRepository extends UmbTreeRepositoryBase {\r\n *   constructor(host: UmbControllerHost) {\r\n *     super(host, NotesTreeServerDataSource, NOTES_TREE_STORE_CONTEXT);\r\n *   }\r\n * }\r\n */\r\nexport class NotesTreeServerDataSource extends UmbTreeServerDataSourceBase<\r\n  TreeItemModel,\r\n  NotesTreeItemModel\r\n> {\r\n  /**\r\n   * Creates a new data source instance.\r\n   *\r\n   * @param {UmbControllerHost} host - The controller host (unused but required by base class)\r\n   */\r\n  constructor(host: UmbControllerHost) {\r\n    super(host, {\r\n      getRootItems,\r\n      getChildrenOf,\r\n      getAncestorsOf,\r\n      mapper,\r\n    });\r\n  }\r\n}\r\n\r\n/**\r\n * Fetches root-level tree items from the API.\r\n *\r\n * Called when the tree first loads or when requesting root items.\r\n * Supports pagination via skip/take parameters.\r\n *\r\n * @param {UmbTreeRootItemsRequestArgs} args - Request arguments with pagination\r\n * @param {number} args.skip - Number of items to skip (offset)\r\n * @param {number} args.take - Maximum number of items to return\r\n *\r\n * @returns {Promise<{data: {items: TreeItemModel[], total: number}}>}\r\n *   Paged response with items and total count\r\n *\r\n * @example\r\n * // Called internally by the repository\r\n * const result = await getRootItems({ skip: 0, take: 100 });\r\n * console.log(result.data.items); // Array of API response items\r\n * console.log(result.data.total); // Total count for pagination\r\n */\r\nconst getRootItems = async (args: UmbTreeRootItemsRequestArgs) => {\r\n  const response = await NoteswikiService.getRoot({\r\n    query: { skip: args.skip, take: args.take },\r\n  });\r\n\r\n  // Return paged model format expected by UmbTreeServerDataSourceBase\r\n  return {\r\n    data: {\r\n      items: response.data.items,\r\n      total: response.data.total,\r\n    },\r\n  };\r\n};\r\n\r\n/**\r\n * Fetches children of a parent tree item.\r\n *\r\n * Called when expanding a tree node to show its children.\r\n * If the parent is the root (unique === null), delegates to getRootItems.\r\n *\r\n * @param {UmbTreeChildrenOfRequestArgs} args - Request arguments\r\n * @param {Object} args.parent - Parent item reference\r\n * @param {string|null} args.parent.unique - Parent's unique ID, null for root\r\n * @param {number} args.skip - Number of items to skip\r\n * @param {number} args.take - Maximum number of items to return\r\n *\r\n * @returns {Promise<{data: {items: TreeItemModel[], total: number}}>}\r\n *   Paged response with child items\r\n *\r\n * @example\r\n * // Fetch children of folder \"abc-123\"\r\n * const result = await getChildrenOf({\r\n *   parent: { unique: \"abc-123\", entityType: NOTES_FOLDER_ENTITY_TYPE },\r\n *   skip: 0,\r\n *   take: 100,\r\n * });\r\n */\r\nconst getChildrenOf = async (args: UmbTreeChildrenOfRequestArgs) => {\r\n  // If parent is null, we're requesting root items\r\n  if (args.parent?.unique === null) {\r\n    return await getRootItems(args);\r\n  }\r\n\r\n  const response = await NoteswikiService.getChildren({\r\n    path: { parentId: args.parent.unique },\r\n    query: { skip: args.skip, take: args.take },\r\n  });\r\n\r\n  return {\r\n    data: {\r\n      items: response.data.items,\r\n      total: response.data.total,\r\n    },\r\n  };\r\n};\r\n\r\n/**\r\n * Fetches ancestors of a tree item for breadcrumb navigation.\r\n *\r\n * Returns the path from root to the specified item, enabling\r\n * breadcrumb displays and \"reveal in tree\" functionality.\r\n *\r\n * @param {UmbTreeAncestorsOfRequestArgs} args - Request arguments\r\n * @param {Object} args.treeItem - The item to get ancestors for\r\n * @param {string} args.treeItem.unique - Unique ID of the item\r\n *\r\n * @returns {Promise<{data: TreeItemModel[]}>} Array of ancestor items from root to parent\r\n *\r\n * @example\r\n * // Get ancestors of note \"note-xyz\"\r\n * const result = await getAncestorsOf({\r\n *   treeItem: { unique: \"note-xyz\", entityType: NOTES_NOTE_ENTITY_TYPE },\r\n * });\r\n * // Result might be: [root-folder, sub-folder] (parents of note-xyz)\r\n */\r\nconst getAncestorsOf = async (args: UmbTreeAncestorsOfRequestArgs) => {\r\n  const response = await NoteswikiService.getAncestors({\r\n    path: { id: args.treeItem.unique },\r\n  });\r\n\r\n  return { data: response.data };\r\n};\r\n\r\n/**\r\n * Maps an API response item to a tree item model.\r\n *\r\n * This is the **critical transformation** that connects API data to the\r\n * Umbraco tree system. The `entityType` property is especially important\r\n * as it determines which workspace opens when a tree item is clicked.\r\n *\r\n * **Entity Type Mapping:**\r\n *\r\n * | API isFolder | entityType Result    | Opens Workspace      |\r\n * |--------------|---------------------|----------------------|\r\n * | true         | NOTES_FOLDER_ENTITY | Folder workspace     |\r\n * | false        | NOTES_NOTE_ENTITY   | Note editor workspace|\r\n *\r\n * **Parent Entity Type:**\r\n *\r\n * The parent's entity type is inferred from whether it has a parentId:\r\n * - Has parentId → Parent is a folder\r\n * - No parentId → Parent is the root\r\n *\r\n * @param {TreeItemModel} item - The API response item to transform\r\n * @returns {NotesTreeItemModel} The transformed tree item model\r\n *\r\n * @example\r\n * // API returns:\r\n * const apiItem = {\r\n *   id: \"123\",\r\n *   name: \"My Note\",\r\n *   isFolder: false,\r\n *   entityType: \"notes-note\",\r\n *   hasChildren: false,\r\n *   icon: \"icon-notepad\",\r\n *   parentId: \"folder-456\",\r\n * };\r\n *\r\n * // Mapper transforms to:\r\n * const treeItem = mapper(apiItem);\r\n * // {\r\n * //   unique: \"123\",\r\n * //   name: \"My Note\",\r\n * //   entityType: \"notes-note\",  // Critical for workspace routing\r\n * //   hasChildren: false,\r\n * //   isFolder: false,\r\n * //   icon: \"icon-notepad\",\r\n * //   parent: { unique: \"folder-456\", entityType: \"notes-folder\" },\r\n * // }\r\n */\r\nconst mapper = (item: TreeItemModel): NotesTreeItemModel => {\r\n  // Determine entity type based on API response\r\n  // This is CRITICAL - it controls which workspace opens on click\r\n  let entityType: typeof NOTES_FOLDER_ENTITY_TYPE | typeof NOTES_NOTE_ENTITY_TYPE;\r\n\r\n  if (item.isFolder || item.entityType === \"notes-folder\") {\r\n    entityType = NOTES_FOLDER_ENTITY_TYPE;\r\n  } else {\r\n    entityType = NOTES_NOTE_ENTITY_TYPE;\r\n  }\r\n\r\n  return {\r\n    unique: item.id,\r\n    parent: {\r\n      unique: item.parentId || null,\r\n      // Infer parent entity type: if no parentId, parent is root\r\n      entityType: item.parentId ? NOTES_FOLDER_ENTITY_TYPE : NOTES_ROOT_ENTITY_TYPE,\r\n    },\r\n    name: item.name,\r\n    entityType: entityType,\r\n    hasChildren: item.hasChildren,\r\n    isFolder: item.isFolder,\r\n    icon: item.icon || (item.isFolder ? \"icon-folder\" : \"icon-notepad\"),\r\n  };\r\n};\r\n","/**\r\n * @fileoverview Notes Tree Repository\r\n *\r\n * The repository is the main interface for tree data operations in the\r\n * Umbraco backoffice. It implements the Repository Pattern to coordinate\r\n * between the data source (API) and the store (cache).\r\n *\r\n * **Architecture Overview:**\r\n *\r\n * ```\r\n * Tree UI ─────> Repository ─────> Data Source ─────> API\r\n *                    │\r\n *                    └──────────> Store (Cache)\r\n * ```\r\n *\r\n * **Repository Pattern Benefits:**\r\n *\r\n * 1. **Abstraction**: Tree UI doesn't know about API details\r\n * 2. **Caching**: Store provides transparent caching\r\n * 3. **Testability**: Easy to mock for unit tests\r\n * 4. **Consistency**: Standard Umbraco tree operations\r\n *\r\n * **Registration:**\r\n *\r\n * The repository is registered via manifest and referenced by the tree:\r\n *\r\n * ```typescript\r\n * // In tree manifest\r\n * {\r\n *   type: \"tree\",\r\n *   meta: {\r\n *     repositoryAlias: NOTES_TREE_REPOSITORY_ALIAS,\r\n *   },\r\n * }\r\n *\r\n * // Repository manifest\r\n * {\r\n *   type: \"repository\",\r\n *   alias: NOTES_TREE_REPOSITORY_ALIAS,\r\n *   api: () => import(\"./notes-tree.repository.js\"),\r\n * }\r\n * ```\r\n *\r\n * Skills demonstrated: umbraco-repository-pattern, umbraco-tree\r\n */\r\n\r\nimport type { UmbControllerHost } from \"@umbraco-cms/backoffice/controller-api\";\r\nimport type { UmbApi } from \"@umbraco-cms/backoffice/extension-api\";\r\nimport { UmbTreeRepositoryBase } from \"@umbraco-cms/backoffice/tree\";\r\nimport { NotesTreeServerDataSource } from \"./notes-tree.server.data-source.js\";\r\nimport { NOTES_TREE_STORE_CONTEXT } from \"./notes-tree.store.js\";\r\nimport {\r\n  NOTES_ROOT_ENTITY_TYPE,\r\n} from \"../constants.js\";\r\nimport type { NotesTreeItemModel, NotesTreeRootModel } from \"./types.js\";\r\n\r\n/**\r\n * Repository for Notes tree operations.\r\n *\r\n * Extends `UmbTreeRepositoryBase` which provides standard tree operations:\r\n * - `requestRootTreeItems()` - Get items at the root level\r\n * - `requestTreeItemsOf(parent)` - Get children of a parent item\r\n * - `requestTreeRoot()` - Get the virtual root model\r\n *\r\n * **Type Parameters:**\r\n * - `NotesTreeItemModel` - The shape of tree items (notes and folders)\r\n * - `NotesTreeRootModel` - The shape of the tree root\r\n *\r\n * **Constructor Parameters:**\r\n * - Data source class: Handles API communication\r\n * - Store context: Provides caching via dependency injection\r\n *\r\n * @implements {UmbApi} - Required for Umbraco extension registration\r\n *\r\n * @example\r\n * // The repository is typically consumed via context in a component:\r\n * const repository = await this.getContext(NOTES_TREE_REPOSITORY_CONTEXT);\r\n * const { data } = await repository.requestRootTreeItems();\r\n * console.log(data); // Array of NotesTreeItemModel\r\n */\r\nexport class NotesTreeRepository\r\n  extends UmbTreeRepositoryBase<NotesTreeItemModel, NotesTreeRootModel>\r\n  implements UmbApi\r\n{\r\n  /**\r\n   * Creates a new Notes tree repository.\r\n   *\r\n   * @param {UmbControllerHost} host - The controller host for context consumption.\r\n   *   This is typically the component or context that creates the repository.\r\n   */\r\n  constructor(host: UmbControllerHost) {\r\n    super(host, NotesTreeServerDataSource, NOTES_TREE_STORE_CONTEXT);\r\n  }\r\n\r\n  /**\r\n   * Returns the root model for the tree.\r\n   *\r\n   * The tree root is a virtual item that represents the top of the hierarchy.\r\n   * It's displayed when `hideTreeRoot: false` in the tree manifest.\r\n   *\r\n   * **Why is this needed?**\r\n   *\r\n   * Unlike regular tree items that come from the API, the root is synthetic.\r\n   * It provides:\r\n   * - A consistent top-level item for navigation\r\n   * - A target for \"Create at root\" actions\r\n   * - An entity type for root-level entity actions\r\n   *\r\n   * @returns {Promise<{data: NotesTreeRootModel}>} The tree root model\r\n   *\r\n   * @example\r\n   * const { data: root } = await repository.requestTreeRoot();\r\n   * console.log(root.entityType); // \"notes-root\"\r\n   * console.log(root.name);       // \"Notes\"\r\n   */\r\n  async requestTreeRoot() {\r\n    const data: NotesTreeRootModel = {\r\n      unique: null,\r\n      entityType: NOTES_ROOT_ENTITY_TYPE,\r\n      name: \"Notes\",\r\n      icon: \"icon-notepad\",\r\n      hasChildren: true,\r\n      isFolder: true,\r\n    };\r\n\r\n    return { data };\r\n  }\r\n}\r\n\r\n/**\r\n * Export the repository class as `api` for Umbraco's extension loader.\r\n *\r\n * When the manifest specifies `api: () => import(\"./notes-tree.repository.js\")`,\r\n * Umbraco looks for the `api` export to instantiate the repository.\r\n */\r\nexport { NotesTreeRepository as api };\r\n"],"names":["NotesTreeServerDataSource","UmbTreeServerDataSourceBase","host","getRootItems","getChildrenOf","getAncestorsOf","mapper","args","response","NoteswikiService","_a","item","entityType","NOTES_FOLDER_ENTITY_TYPE","NOTES_NOTE_ENTITY_TYPE","NOTES_ROOT_ENTITY_TYPE","NotesTreeRepository","UmbTreeRepositoryBase","NOTES_TREE_STORE_CONTEXT"],"mappings":";;;;;AAkEO,MAAMA,UAAkCC,EAG7C;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAMA,YAAYC,GAAyB;AACnC,UAAMA,GAAM;AAAA,MACV,cAAAC;AAAA,MACA,eAAAC;AAAA,MACA,gBAAAC;AAAA,MACA,QAAAC;AAAA,IAAA,CACD;AAAA,EACH;AACF;AAqBA,MAAMH,IAAe,OAAOI,MAAsC;AAChE,QAAMC,IAAW,MAAMC,EAAiB,QAAQ;AAAA,IAC9C,OAAO,EAAE,MAAMF,EAAK,MAAM,MAAMA,EAAK,KAAA;AAAA,EAAK,CAC3C;AAGD,SAAO;AAAA,IACL,MAAM;AAAA,MACJ,OAAOC,EAAS,KAAK;AAAA,MACrB,OAAOA,EAAS,KAAK;AAAA,IAAA;AAAA,EACvB;AAEJ,GAyBMJ,IAAgB,OAAOG,MAAuC;;AAElE,QAAIG,IAAAH,EAAK,WAAL,gBAAAG,EAAa,YAAW;AAC1B,WAAO,MAAMP,EAAaI,CAAI;AAGhC,QAAMC,IAAW,MAAMC,EAAiB,YAAY;AAAA,IAClD,MAAM,EAAE,UAAUF,EAAK,OAAO,OAAA;AAAA,IAC9B,OAAO,EAAE,MAAMA,EAAK,MAAM,MAAMA,EAAK,KAAA;AAAA,EAAK,CAC3C;AAED,SAAO;AAAA,IACL,MAAM;AAAA,MACJ,OAAOC,EAAS,KAAK;AAAA,MACrB,OAAOA,EAAS,KAAK;AAAA,IAAA;AAAA,EACvB;AAEJ,GAqBMH,IAAiB,OAAOE,OAKrB,EAAE,OAJQ,MAAME,EAAiB,aAAa;AAAA,EACnD,MAAM,EAAE,IAAIF,EAAK,SAAS,OAAA;AAAO,CAClC,GAEuB,KAAA,IAkDpBD,IAAS,CAACK,MAA4C;AAG1D,MAAIC;AAEJ,SAAID,EAAK,YAAYA,EAAK,eAAe,iBACvCC,IAAaC,IAEbD,IAAaE,GAGR;AAAA,IACL,QAAQH,EAAK;AAAA,IACb,QAAQ;AAAA,MACN,QAAQA,EAAK,YAAY;AAAA;AAAA,MAEzB,YAAYA,EAAK,WAAWE,IAA2BE;AAAA,IAAA;AAAA,IAEzD,MAAMJ,EAAK;AAAA,IACX,YAAAC;AAAA,IACA,aAAaD,EAAK;AAAA,IAClB,UAAUA,EAAK;AAAA,IACf,MAAMA,EAAK,SAASA,EAAK,WAAW,gBAAgB;AAAA,EAAA;AAExD;AClLO,MAAMK,UACHC,EAEV;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOE,YAAYf,GAAyB;AACnC,UAAMA,GAAMF,GAA2BkB,CAAwB;AAAA,EACjE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAuBA,MAAM,kBAAkB;AAUtB,WAAO,EAAE,MATwB;AAAA,MAC/B,QAAQ;AAAA,MACR,YAAYH;AAAA,MACZ,MAAM;AAAA,MACN,MAAM;AAAA,MACN,aAAa;AAAA,MACb,UAAU;AAAA,IAAA,EAGH;AAAA,EACX;AACF;"}